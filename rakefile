require 'fileutils'

CLK_SPEED_HZ = 3_686_400

HERE = __dir__
CONFIG = File.expand_path(File.join(HERE, 'lib/config/modularz80.cfg'))

LIB_INCLUDE = File.join(HERE, 'lib/include')

CRT0 = File.join(HERE, 'lib/crt0.asm')

task :crt0 do
    system("z80asm -mz80 -R -o#{File.basename(CRT0, ".asm")}.o #{CRT0}")
end

task :stdlib do
    FileUtils.mkdir "lib/stdlib/tmp" unless Dir.exist? "lib/stdlib/tmp"

    system("m4 lib/stdlib/stdio.asm > lib/stdlib/tmp/stdio.asm")
    system("zcc +#{CONFIG} -nostdlib -c -o lib/stdlib.o lib/stdlib/tmp/stdio.asm")
    system("z80asm -xlib/stdlib.lib lib/stdlib.o")
end

rule ".o" => ".c" do |t|
    system("zcc +#{CONFIG} -nostdlib -I#{LIB_INCLUDE} -c -o #{t.name} #{t.source}")
end

task :test => ["test.o", :crt0, :stdlib] do
    system("z80asm -Llib/ -lstdlib.lib -r0x8000 -b test.o #{CRT0}")
    system("appmake +hex -b test.bin --org 0x8000 -o test.hex")
    system("z88dk-dis -o 0x8000 test.bin > test.diss")
end
